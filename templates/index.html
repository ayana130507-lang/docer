<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Docer — Приложение</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <div class="brand">
          <img src="/static/logo.svg" alt="Docer logo" class="logo">
          <div>
            <div class="brand-title">Docer</div>
            <div class="brand-sub">Контейнеризированное приложение</div>
          </div>
        </div>
        <nav class="nav">
          <a href="/">API</a>
          <a href="/ui" class="active">UI</a>
          <a href="#info">Info</a>
        </nav>
      </div>
    </header>

    <main class="container main-grid">
      <section class="hero">
        <h1>Приложение запущено</h1>
        <p class="lead">Нажмите кнопку, чтобы получить текущий статус приложения или откройте API напрямую.</p>
        <div class="actions">
          <button id="refresh" class="btn btn-primary">Обновить статус</button>
          <a class="btn btn-ghost" href="/">GET / (JSON)</a>
        </div>
      </section>

      <aside class="status-card">
        <div class="status-badge" id="status-badge">—</div>
        <h3 id="status-text">Загрузка...</h3>
        <p id="status-message" class="muted">Подождите, выполняется запрос к API.</p>

        <hr>

        <h4>Запрос</h4>
        <pre class="code">curl -s http://your-host:5000 | jq</pre>
        <button id="copyCurl" class="btn small">Скопировать</button>
      </aside>
    </main>
    <section id="crud" class="container crud-section">
      <div class="crud-left">
        <div class="card">
          <h3>Элементы (Items)</h3>
          <p class="muted">Добавляйте, редактируйте и удаляйте простые элементы — это демонстрация CRUD.</p>

          <form id="itemForm" class="item-form">
            <input type="hidden" id="itemId">
            <div class="form-row">
              <input id="itemName" placeholder="Название" required />
            </div>
            <div class="form-row">
              <input id="itemDescription" placeholder="Описание (необязательно)" />
            </div>
            <div class="form-row actions">
              <button id="saveItem" class="btn btn-primary">Создать</button>
              <button id="cancelEdit" type="button" class="btn btn-ghost">Отмена</button>
            </div>
          </form>

          <hr>

          <div id="itemsList" class="items-list">
            <!-- items go here -->
          </div>
        </div>
      </div>

      <aside class="crud-right card status-card">
        <h4>Инструменты</h4>
        <p class="muted">Используйте кнопки справа от каждого элемента для действий: <strong>View</strong>, <strong>Edit</strong>, <strong>Delete</strong>.</p>
        <p class="muted">API endpoints: <code>/items</code> (GET, POST), <code>/items/:id</code> (PUT, DELETE)</p>
      </aside>
    </section>

    <footer class="site-footer">
      <div class="container">© Docer — autogenerated demo • Быстро, просто, красиво</div>
    </footer>

    <script>
      // Status widget
      async function updateStatus(){
        const badge = document.getElementById('status-badge');
        const text = document.getElementById('status-text');
        const message = document.getElementById('status-message');
        try{
          const res = await fetch('/');
          const json = await res.json();
          if(json.status && json.status.toLowerCase() === 'ok'){
            badge.textContent = 'OK';
            badge.classList.remove('bad-warn');
            badge.classList.add('bad-ok');
            text.textContent = 'Сервис доступен';
          } else {
            badge.textContent = 'ERR';
            badge.classList.remove('bad-ok');
            badge.classList.add('bad-warn');
            text.textContent = 'Есть проблемы';
          }
          message.textContent = json.message || '';
        }catch(e){
          badge.textContent = 'OFF';
          badge.classList.remove('bad-ok');
          badge.classList.add('bad-warn');
          text.textContent = 'Не удалось подключиться';
          message.textContent = 'Проверьте, запущено ли приложение.';
        }
      }

      // CRUD functionality
      async function fetchItems(){
        const res = await fetch('/items');
        const data = await res.json();
        renderItems(data.items || []);
      }

      function renderItems(items){
        const container = document.getElementById('itemsList');
        container.innerHTML = '';
        if(items.length === 0){
          container.innerHTML = '<div class="muted">Пока нет элементов. Создайте первый.</div>';
          return;
        }
        for(const it of items){
          const el = document.createElement('div');
          el.className = 'item';
          el.innerHTML = `
            <div class="item-head">
              <div class="item-title">${escapeHtml(it.name)}</div>
              <div class="item-actions">
                <button class="btn small" data-action="view" data-id="${it.id}">View</button>
                <button class="btn small" data-action="edit" data-id="${it.id}">Edit</button>
                <button class="btn small danger" data-action="delete" data-id="${it.id}">Delete</button>
              </div>
            </div>
            <div class="item-desc">${escapeHtml(it.description || '')}</div>
          `;
          container.appendChild(el);
        }
      }

      function escapeHtml(s){
        return String(s).replace(/[&<>\"]/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[m]});
      }

      document.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-action]');
        if(!btn) return;
        const action = btn.dataset.action;
        const id = btn.dataset.id && Number(btn.dataset.id);
        if(action === 'view'){
          const res = await fetch(`/items`);
          const data = await res.json();
          const item = (data.items||[]).find(x=>x.id===id);
          if(item) alert(JSON.stringify(item, null, 2));
        } else if(action === 'edit'){
          // populate form
          const res = await fetch(`/items`);
          const data = await res.json();
          const item = (data.items||[]).find(x=>x.id===id);
          if(item){
            document.getElementById('itemId').value = item.id;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('saveItem').textContent = 'Сохранить';
          }
        } else if(action === 'delete'){
          if(!confirm('Удалить элемент?')) return;
          await fetch(`/items/${id}`, {method:'DELETE'});
          await fetchItems();
        }
      });

      document.getElementById('itemForm').addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const id = document.getElementById('itemId').value;
        const name = document.getElementById('itemName').value.trim();
        const description = document.getElementById('itemDescription').value.trim();
        if(!name){ alert('Введите название'); return; }
        if(id){
          await fetch(`/items/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name,description})});
        } else {
          await fetch('/items', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name,description})});
        }
        // reset
        document.getElementById('itemId').value = '';
        document.getElementById('itemName').value = '';
        document.getElementById('itemDescription').value = '';
        document.getElementById('saveItem').textContent = 'Создать';
        await fetchItems();
      });

      document.getElementById('cancelEdit').addEventListener('click', ()=>{
        document.getElementById('itemId').value = '';
        document.getElementById('itemName').value = '';
        document.getElementById('itemDescription').value = '';
        document.getElementById('saveItem').textContent = 'Создать';
      });

      document.getElementById('refresh').addEventListener('click', updateStatus);
      document.getElementById('copyCurl').addEventListener('click', async ()=>{
        const text = 'curl -s http://localhost:5000 | jq';
        await navigator.clipboard.writeText(text);
        alert('Команда скопирована в буфер обмена');
      });

      // initial
      updateStatus();
      fetchItems();
    </script>
  </body>
</html>
